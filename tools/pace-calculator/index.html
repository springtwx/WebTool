<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>跑步配速计算器</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f6f7f9;
      --card: #ffffff;
      --text: #1b1f24;
      --muted: #5b6776;
      --accent: #1f5eff;
      --border: #e3e7ee;
      font-family: "Inter", "Noto Sans SC", system-ui, -apple-system, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    [hidden] {
      display: none !important;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    main {
      max-width: 1080px;
      margin: 0 auto;
      padding: 48px 24px 80px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 32px;
    }

    header a {
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
    }

    header h1 {
      margin: 0;
      font-size: 30px;
    }

    header p {
      margin: 0;
      color: var(--muted);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .copy-link {
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      transition: border 0.2s ease, color 0.2s ease;
    }

    .copy-link:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
      box-shadow: 0 12px 24px rgba(14, 23, 38, 0.06);
    }

    .mode-toggle {
      display: inline-flex;
      background: #eef1f6;
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
    }

    .mode-toggle button {
      border: none;
      background: transparent;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 14px;
      color: var(--muted);
      cursor: pointer;
    }

    .mode-toggle button.active {
      background: var(--card);
      color: var(--text);
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(14, 23, 38, 0.08);
    }

    .section {
      display: none;
      margin-top: 24px;
    }

    .section.active {
      display: block;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 14px;
      color: var(--muted);
    }

    select,
    input {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      color: var(--text);
    }

    .subtle {
      color: var(--muted);
      font-size: 13px;
      margin-top: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    th,
    td {
      text-align: left;
      padding: 12px 8px;
      border-bottom: 1px solid var(--border);
    }

    th {
      color: var(--muted);
      font-weight: 500;
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .result-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .result-card strong {
      font-size: 18px;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 20px 0 8px;
    }

    .unit-toggle {
      display: inline-flex;
      background: #eef1f6;
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
    }

    .unit-toggle button {
      border: none;
      background: transparent;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--muted);
      cursor: pointer;
    }

    .unit-toggle button.active {
      background: var(--card);
      color: var(--text);
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(14, 23, 38, 0.08);
    }

    .table-note {
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
    }

    .table-note span {
      color: var(--text);
      font-weight: 600;
    }

    .segment-card {
      margin-top: 20px;
    }

    .segment-card h3 {
      margin: 0 0 8px;
      font-size: 18px;
    }

    .segment-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .segment-toggle select {
      min-width: 160px;
    }

    .hint {
      font-size: 13px;
      color: var(--muted);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #f0f4ff;
      color: #1f4acc;
      font-size: 12px;
    }

    .status-pill[data-tone="warn"] {
      background: #fff4ef;
      color: #c24d1d;
    }

    .label-inline {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .label-inline .unit-inline {
      white-space: nowrap;
    }

    @media (max-width: 720px) {
      main {
        padding: 40px 20px 64px;
      }

      header h1 {
        font-size: 24px;
      }

      .card {
        padding: 18px;
      }
    }

    @media (max-width: 520px) {
      main {
        padding: 32px 16px 56px;
      }

      .header-actions {
        align-items: flex-start;
      }

      .mode-toggle {
        flex-wrap: wrap;
      }

      table {
        min-width: 420px;
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <a href="../../">← 返回工具首页</a>
      <div class="header-actions">
        <h1>跑步配速计算器</h1>
        <button class="copy-link" type="button" id="copy-link">复制此工具链接</button>
      </div>
      <p>切换快捷模式或自由模式，快速得到配速、时速与完赛时间。</p>
      <div class="unit-toggle" role="tablist" aria-label="切换距离单位">
        <button type="button" class="active" data-unit="km">公里</button>
        <button type="button" data-unit="mi">英里</button>
      </div>
      <div class="mode-toggle" role="tablist">
        <button type="button" class="active" data-mode="quick">快捷模式</button>
        <button type="button" data-mode="flex">自由模式</button>
      </div>
    </header>

    <section class="card section active" id="quick-section">
      <h2>快捷模式</h2>
      <p class="subtle">选择输入类型后，即可看到常见比赛距离的配速与完赛时间。</p>
      <div class="input-grid">
        <label>
          输入类型
          <select id="quick-input-type">
            <option value="pace" selected>配速（分:秒 / 公里）</option>
            <option value="time">时间（总用时）</option>
            <option value="speed">时速（km/h）</option>
          </select>
        </label>
        <label data-quick-input="pace">
          <span class="label-inline">
            配速
            <span class="unit-inline">（分:秒 / <span data-unit-distance>公里</span>）</span>
          </span>
          <div class="input-grid" style="grid-template-columns: repeat(2, minmax(80px, 1fr));">
            <input type="number" id="pace-min" min="0" placeholder="分" />
            <input type="number" id="pace-sec" min="0" max="59" placeholder="秒" />
          </div>
        </label>
        <label data-quick-input="time" hidden>
          时间（总用时）
          <div class="input-grid" style="grid-template-columns: repeat(3, minmax(70px, 1fr));">
            <input type="number" id="time-hour" min="0" placeholder="时" />
            <input type="number" id="time-min" min="0" max="59" placeholder="分" />
            <input type="number" id="time-sec" min="0" max="59" placeholder="秒" />
          </div>
        </label>
        <label data-quick-input="speed" hidden>
          <span class="label-inline">
            时速
            <span class="unit-inline">（<span data-unit-speed>km/h</span>）</span>
          </span>
          <input type="number" id="speed-input" min="0" step="0.1" placeholder="例如 12.0" />
        </label>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>距离</th>
              <th>完赛时间</th>
              <th>配速</th>
              <th>时速</th>
            </tr>
          </thead>
          <tbody id="quick-table-body"></tbody>
        </table>
      </div>
      <p class="table-note">
        点击距离查看分段配速表，分段规则：总距离 <span data-segment-threshold>15</span>
        <span data-unit-distance>公里</span> 使用 3<span data-unit-distance>公里</span>，其余使用
        5<span data-unit-distance>公里</span>。
      </p>

      <section class="card segment-card" id="quick-segment-card" hidden>
        <div class="segment-toggle">
          <h3 id="segment-title">分段配速表</h3>
          <span class="status-pill" id="segment-unit">公里</span>
          <span class="hint" id="segment-rule">每 5km 分段</span>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>分段</th>
                <th>该段距离</th>
                <th>该段用时</th>
                <th>平均配速</th>
              </tr>
            </thead>
            <tbody id="segment-table-body"></tbody>
          </table>
        </div>
      </section>
    </section>

    <section class="card section" id="flex-section">
      <h2>自由模式</h2>
      <p class="subtle">填写距离 + 选择一项输入，即可计算另外两项（时间、配速、时速）。</p>
      <div class="input-grid">
        <label>
          <span class="label-inline">
            距离
            <span class="unit-inline">（<span data-unit-distance>公里</span>）</span>
          </span>
          <input type="number" id="flex-distance" min="0" step="0.01" placeholder="例如 10" />
        </label>
        <label>
          选择输入项
          <select id="flex-input-type">
            <option value="time">时间（总用时）</option>
            <option value="pace" selected>配速（分:秒 / 公里）</option>
            <option value="speed">时速（km/h）</option>
          </select>
        </label>
        <label data-flex-input="time" hidden>
          时间（总用时）
          <div class="input-grid" style="grid-template-columns: repeat(3, minmax(70px, 1fr));">
            <input type="number" id="flex-hour" min="0" placeholder="时" />
            <input type="number" id="flex-min" min="0" max="59" placeholder="分" />
            <input type="number" id="flex-sec" min="0" max="59" placeholder="秒" />
          </div>
        </label>
        <label data-flex-input="pace" hidden>
          <span class="label-inline">
            配速
            <span class="unit-inline">（分:秒 / <span data-unit-distance>公里</span>）</span>
          </span>
          <div class="input-grid" style="grid-template-columns: repeat(2, minmax(80px, 1fr));">
            <input type="number" id="flex-pace-min" min="0" placeholder="分" />
            <input type="number" id="flex-pace-sec" min="0" max="59" placeholder="秒" />
          </div>
        </label>
        <label data-flex-input="speed" hidden>
          <span class="label-inline">
            时速
            <span class="unit-inline">（<span data-unit-speed>km/h</span>）</span>
          </span>
          <input type="number" id="flex-speed" min="0" step="0.1" placeholder="例如 12.0" />
        </label>
      </div>

      <div class="divider"></div>
      <div class="result-grid">
        <div class="result-card">
          <span class="subtle">完成时间</span>
          <strong id="flex-result-time">--</strong>
        </div>
        <div class="result-card">
          <span class="subtle">
            配速（分:秒 / <span class="unit-inline"><span data-unit-distance>公里</span></span>）
          </span>
          <strong id="flex-result-pace">--</strong>
        </div>
        <div class="result-card">
          <span class="subtle">
            时速（<span class="unit-inline"><span data-unit-speed>km/h</span></span>）
          </span>
          <strong id="flex-result-speed">--</strong>
        </div>
      </div>

      <div class="divider"></div>
      <h3>训练进度推算</h3>
      <p class="subtle">基于自由模式的距离输入当前进度与目标时间（可选），生成预测完赛时间与剩余分段配速表。</p>
      <div class="input-grid">
        <label>
          <span class="label-inline">
            已跑距离
            <span class="unit-inline">（<span data-unit-distance>公里</span>）</span>
          </span>
          <input type="number" id="progress-current-distance" min="0" step="0.01" placeholder="例如 10" />
        </label>
        <label>
          已跑用时
          <div class="input-grid" style="grid-template-columns: repeat(3, minmax(70px, 1fr));">
            <input type="number" id="progress-hour" min="0" placeholder="时" />
            <input type="number" id="progress-min" min="0" max="59" placeholder="分" />
            <input type="number" id="progress-sec" min="0" max="59" placeholder="秒" />
          </div>
        </label>
        <label>
          目标完赛时间（可选）
          <div class="input-grid" style="grid-template-columns: repeat(3, minmax(70px, 1fr));">
            <input type="number" id="target-hour" min="0" placeholder="时" />
            <input type="number" id="target-min" min="0" max="59" placeholder="分" />
            <input type="number" id="target-sec" min="0" max="59" placeholder="秒" />
          </div>
        </label>
      </div>

      <div class="result-grid">
        <div class="result-card">
          <span class="subtle">预测完赛时间</span>
          <strong id="progress-result-time">--</strong>
        </div>
        <div class="result-card">
          <span class="subtle">当前平均配速</span>
          <strong id="progress-result-pace">--</strong>
        </div>
        <div class="result-card">
          <span class="subtle">与目标配速差</span>
          <strong id="progress-result-diff">--</strong>
          <span class="hint" id="progress-diff-hint">填写目标完赛时间后计算</span>
        </div>
      </div>

      <section class="card segment-card" id="remaining-segment-card" hidden>
        <div class="segment-toggle">
          <h3 id="remaining-title">剩余分段配速表</h3>
          <span class="status-pill" id="remaining-unit">公里</span>
          <span class="hint" id="remaining-rule">按剩余距离分段</span>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>分段</th>
                <th>该段距离</th>
                <th>该段用时</th>
                <th>平均配速</th>
              </tr>
            </thead>
            <tbody id="remaining-table-body"></tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <script>
    const copyButton = document.getElementById("copy-link");
    const unitButtons = document.querySelectorAll(".unit-toggle button");
    const unitLabels = {
      km: { name: "公里", paceUnit: "分:秒 / 公里", speedUnit: "km/h", distanceUnit: "km" },
      mi: { name: "英里", paceUnit: "分:秒 / 英里", speedUnit: "mph", distanceUnit: "mi" }
    };
    const milesPerKm = 0.621371;
    let currentUnit = "km";
    let selectedQuickDistance = null;

    const distances = [
      { label: "3K", km: 3 },
      { label: "5K", km: 5 },
      { label: "10K", km: 10 },
      { label: "15K", km: 15 },
      { label: "20K", km: 20 },
      { label: "30K", km: 30 },
      { label: "半马", km: 21.0975 },
      { label: "全马", km: 42.195 }
    ];

    const quickTableBody = document.getElementById("quick-table-body");
    const quickInputType = document.getElementById("quick-input-type");
    const quickInputs = document.querySelectorAll("[data-quick-input]");
    const quickPaceOption = quickInputType.querySelector('option[value="pace"]');
    const quickSpeedOption = quickInputType.querySelector('option[value="speed"]');

    const timeHour = document.getElementById("time-hour");
    const timeMin = document.getElementById("time-min");
    const timeSec = document.getElementById("time-sec");

    const paceMin = document.getElementById("pace-min");
    const paceSec = document.getElementById("pace-sec");

    const speedInput = document.getElementById("speed-input");

    const flexDistance = document.getElementById("flex-distance");
    const flexInputType = document.getElementById("flex-input-type");
    const flexInputs = document.querySelectorAll("[data-flex-input]");
    const flexPaceOption = flexInputType.querySelector('option[value="pace"]');
    const flexSpeedOption = flexInputType.querySelector('option[value="speed"]');
    const flexHour = document.getElementById("flex-hour");
    const flexMin = document.getElementById("flex-min");
    const flexSec = document.getElementById("flex-sec");
    const flexPaceMin = document.getElementById("flex-pace-min");
    const flexPaceSec = document.getElementById("flex-pace-sec");
    const flexSpeed = document.getElementById("flex-speed");

    const flexResultTime = document.getElementById("flex-result-time");
    const flexResultPace = document.getElementById("flex-result-pace");
    const flexResultSpeed = document.getElementById("flex-result-speed");

    const segmentCard = document.getElementById("quick-segment-card");
    const segmentTableBody = document.getElementById("segment-table-body");
    const segmentTitle = document.getElementById("segment-title");
    const segmentUnit = document.getElementById("segment-unit");
    const segmentRule = document.getElementById("segment-rule");

    const progressCurrentDistance = document.getElementById("progress-current-distance");
    const progressHour = document.getElementById("progress-hour");
    const progressMin = document.getElementById("progress-min");
    const progressSec = document.getElementById("progress-sec");
    const targetHour = document.getElementById("target-hour");
    const targetMin = document.getElementById("target-min");
    const targetSec = document.getElementById("target-sec");

    const progressResultTime = document.getElementById("progress-result-time");
    const progressResultPace = document.getElementById("progress-result-pace");
    const progressResultDiff = document.getElementById("progress-result-diff");
    const progressDiffHint = document.getElementById("progress-diff-hint");

    const remainingSegmentCard = document.getElementById("remaining-segment-card");
    const remainingTableBody = document.getElementById("remaining-table-body");
    const remainingTitle = document.getElementById("remaining-title");
    const remainingUnit = document.getElementById("remaining-unit");
    const remainingRule = document.getElementById("remaining-rule");

    function toNumber(value) {
      const number = Number(value);
      return Number.isFinite(number) ? number : 0;
    }

    function parseTime(hours, minutes, seconds) {
      return toNumber(hours) * 3600 + toNumber(minutes) * 60 + toNumber(seconds);
    }

    function parsePace(minutes, seconds) {
      return toNumber(minutes) * 60 + toNumber(seconds);
    }

    function formatTime(totalSeconds) {
      if (!Number.isFinite(totalSeconds) || totalSeconds <= 0) {
        return "--";
      }
      const rounded = Math.round(totalSeconds);
      const hours = Math.floor(rounded / 3600);
      const minutes = Math.floor((rounded % 3600) / 60);
      const seconds = rounded % 60;
      const parts = [hours, minutes, seconds].map((part) => String(part).padStart(2, "0"));
      return parts.join(":");
    }

    function formatPace(secondsPerKm) {
      if (!Number.isFinite(secondsPerKm) || secondsPerKm <= 0) {
        return "--";
      }
      const rounded = Math.round(secondsPerKm);
      const minutes = Math.floor(rounded / 60);
      const seconds = rounded % 60;
      return `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    }

    function formatSpeed(kmPerHour) {
      if (!Number.isFinite(kmPerHour) || kmPerHour <= 0) {
        return "--";
      }
      return kmPerHour.toFixed(1);
    }

    function getUnitDistance(distanceKm) {
      return currentUnit === "km" ? distanceKm : distanceKm * milesPerKm;
    }

    function getSegmentSize(distanceKm) {
      const baseDistance = currentUnit === "km" ? distanceKm : distanceKm * milesPerKm;
      return baseDistance < 15 ? 3 : 5;
    }

    function formatDistance(distanceKm, decimals = 1) {
      const unitDistance = getUnitDistance(distanceKm);
      const rounded = unitDistance >= 10 ? unitDistance.toFixed(1) : unitDistance.toFixed(decimals);
      return `${rounded} ${unitLabels[currentUnit].distanceUnit}`;
    }

    function formatSpeedByUnit(kmPerHour) {
      if (!Number.isFinite(kmPerHour) || kmPerHour <= 0) {
        return "--";
      }
      const speed = currentUnit === "km" ? kmPerHour : kmPerHour * milesPerKm;
      return speed.toFixed(1);
    }

    function formatPaceByUnit(secondsPerKm) {
      if (!Number.isFinite(secondsPerKm) || secondsPerKm <= 0) {
        return "--";
      }
      const secondsPerUnit = currentUnit === "km" ? secondsPerKm : secondsPerKm / milesPerKm;
      return formatPace(secondsPerUnit);
    }

    function convertDistanceToKm(distanceValue) {
      if (!Number.isFinite(distanceValue) || distanceValue <= 0) {
        return 0;
      }
      return currentUnit === "km" ? distanceValue : distanceValue / milesPerKm;
    }

    function convertPaceToKm(paceSeconds) {
      if (!Number.isFinite(paceSeconds) || paceSeconds <= 0) {
        return 0;
      }
      return currentUnit === "km" ? paceSeconds : paceSeconds * milesPerKm;
    }

    function convertSpeedToKm(speedValue) {
      if (!Number.isFinite(speedValue) || speedValue <= 0) {
        return 0;
      }
      return currentUnit === "km" ? speedValue : speedValue / milesPerKm;
    }

    function updateUnitLabels() {
      const distanceLabels = document.querySelectorAll("[data-unit-distance]");
      const speedLabels = document.querySelectorAll("[data-unit-speed]");
      distanceLabels.forEach((label) => {
        label.textContent = unitLabels[currentUnit].distanceUnit === "km" ? "公里" : "英里";
      });
      speedLabels.forEach((label) => {
        label.textContent = unitLabels[currentUnit].speedUnit;
      });
      quickPaceOption.textContent = `配速（分:秒 / ${unitLabels[currentUnit].name}）`;
      quickSpeedOption.textContent = `时速（${unitLabels[currentUnit].speedUnit}）`;
      flexPaceOption.textContent = `配速（分:秒 / ${unitLabels[currentUnit].name}）`;
      flexSpeedOption.textContent = `时速（${unitLabels[currentUnit].speedUnit}）`;
    }

    function convertInputValue(value, multiplier) {
      if (!Number.isFinite(value) || value <= 0) {
        return "";
      }
      return (value * multiplier).toFixed(2);
    }

    function convertPaceInputs(multiplier) {
      const paceValue = parsePace(paceMin.value, paceSec.value);
      if (paceValue > 0) {
        const converted = paceValue * multiplier;
        const minutes = Math.floor(converted / 60);
        const seconds = Math.round(converted % 60);
        paceMin.value = minutes;
        paceSec.value = seconds;
      }

      const flexPaceValue = parsePace(flexPaceMin.value, flexPaceSec.value);
      if (flexPaceValue > 0) {
        const converted = flexPaceValue * multiplier;
        const minutes = Math.floor(converted / 60);
        const seconds = Math.round(converted % 60);
        flexPaceMin.value = minutes;
        flexPaceSec.value = seconds;
      }
    }

    function convertUnits(fromUnit, toUnit) {
      if (fromUnit === toUnit) {
        return;
      }
      const multiplier = fromUnit === "km" && toUnit === "mi" ? milesPerKm : 1 / milesPerKm;

      flexDistance.value = convertInputValue(toNumber(flexDistance.value), multiplier);
      progressCurrentDistance.value = convertInputValue(toNumber(progressCurrentDistance.value), multiplier);

      speedInput.value = convertInputValue(toNumber(speedInput.value), multiplier);
      flexSpeed.value = convertInputValue(toNumber(flexSpeed.value), multiplier);

      convertPaceInputs(fromUnit === "km" && toUnit === "mi" ? 1 / milesPerKm : milesPerKm);
    }

    function buildSegments(distanceKm, totalSeconds) {
      if (!Number.isFinite(distanceKm) || distanceKm <= 0 || !Number.isFinite(totalSeconds) || totalSeconds <= 0) {
        return [];
      }
      const unitDistance = getUnitDistance(distanceKm);
      const segmentSize = getSegmentSize(distanceKm);
      const fullSegments = Math.floor(unitDistance / segmentSize);
      const remainder = unitDistance - fullSegments * segmentSize;
      const secondsPerUnit = totalSeconds / unitDistance;
      const segments = [];
      let cumulative = 0;

      for (let i = 0; i < fullSegments; i += 1) {
        cumulative += segmentSize;
        segments.push({
          label: `第 ${i + 1} 段`,
          distance: `${segmentSize.toFixed(1)} ${unitLabels[currentUnit].distanceUnit}`,
          time: formatTime(secondsPerUnit * segmentSize),
          pace: formatPace(secondsPerUnit)
        });
      }

      if (remainder > 0.05) {
        cumulative += remainder;
        segments.push({
          label: `第 ${segments.length + 1} 段`,
          distance: `${remainder.toFixed(2)} ${unitLabels[currentUnit].distanceUnit}`,
          time: formatTime(secondsPerUnit * remainder),
          pace: formatPace(secondsPerUnit)
        });
      }

      return { segments, segmentSize };
    }

    function renderSegmentTable(rows, body) {
      body.innerHTML = rows
        .map(
          (row) => `
          <tr>
            <td>${row.label}</td>
            <td>${row.distance}</td>
            <td>${row.time}</td>
            <td>${row.pace}</td>
          </tr>
        `
        )
        .join("");
    }

    function renderQuickTable(rows) {
      quickTableBody.innerHTML = rows
        .map(
          (row) => `
          <tr data-distance="${row.distanceKm}">
            <td>${row.label}</td>
            <td>${row.time}</td>
            <td>${row.pace}</td>
            <td>${row.speed}</td>
          </tr>
        `
        )
        .join("");
    }

    function updateQuickMode() {
      const type = quickInputType.value;
      quickInputs.forEach((input) => {
        input.hidden = input.dataset.quickInput !== type;
      });

      let rows = distances.map((distance) => {
        let totalSeconds = 0;
        if (type === "time") {
          totalSeconds = parseTime(timeHour.value, timeMin.value, timeSec.value);
        }
        if (type === "pace") {
          const paceSeconds = convertPaceToKm(parsePace(paceMin.value, paceSec.value));
          totalSeconds = paceSeconds * distance.km;
        }
        if (type === "speed") {
          const speedValue = convertSpeedToKm(toNumber(speedInput.value));
          totalSeconds = speedValue > 0 ? (distance.km / speedValue) * 3600 : 0;
        }

        const paceSeconds = totalSeconds > 0 ? totalSeconds / distance.km : 0;
        const speedValue = totalSeconds > 0 ? distance.km / (totalSeconds / 3600) : 0;

        return {
          label: distance.label,
          time: formatTime(totalSeconds),
          pace: formatPaceByUnit(paceSeconds),
          speed: formatSpeedByUnit(speedValue),
          distanceKm: distance.km
        };
      });

      renderQuickTable(rows);
      bindQuickRowEvents();
      updateSegmentCard(selectedQuickDistance);
    }

    function bindQuickRowEvents() {
      document.querySelectorAll("#quick-table-body tr").forEach((row) => {
        row.addEventListener("click", () => {
          const distanceKm = toNumber(row.dataset.distance);
          selectedQuickDistance = distanceKm;
          updateSegmentCard(distanceKm);
        });
      });
    }

    function updateSegmentCard(distanceKm) {
      if (!distanceKm) {
        segmentCard.hidden = true;
        return;
      }
      const paceSeconds = convertPaceToKm(parsePace(paceMin.value, paceSec.value));
      const totalSeconds =
        quickInputType.value === "pace"
          ? paceSeconds * distanceKm
          : quickInputType.value === "time"
          ? parseTime(timeHour.value, timeMin.value, timeSec.value)
          : quickInputType.value === "speed"
          ? (() => {
              const speedValue = convertSpeedToKm(toNumber(speedInput.value));
              return speedValue > 0 ? (distanceKm / speedValue) * 3600 : 0;
            })()
          : 0;

      const segmentData = buildSegments(distanceKm, totalSeconds);
      if (!segmentData || segmentData.segments.length === 0) {
        segmentCard.hidden = true;
        return;
      }

      segmentCard.hidden = false;
      segmentTitle.textContent = `${formatDistance(distanceKm, 2)} 分段配速表`;
      segmentUnit.textContent = unitLabels[currentUnit].name;
      segmentRule.textContent = `每 ${segmentData.segmentSize} ${unitLabels[currentUnit].distanceUnit} 分段`;
      renderSegmentTable(segmentData.segments, segmentTableBody);
    }

    function updateFlexMode() {
      const inputType = flexInputType.value;
      flexInputs.forEach((input) => {
        input.hidden = input.dataset.flexInput !== inputType;
      });

      const distanceKm = convertDistanceToKm(toNumber(flexDistance.value));
      const timeSeconds = parseTime(flexHour.value, flexMin.value, flexSec.value);
      const paceSeconds = convertPaceToKm(parsePace(flexPaceMin.value, flexPaceSec.value));
      const speedValue = convertSpeedToKm(toNumber(flexSpeed.value));

      let totalSeconds = 0;

      if (distanceKm > 0) {
        if (inputType === "time" && timeSeconds > 0) {
          totalSeconds = timeSeconds;
        } else if (inputType === "pace" && paceSeconds > 0) {
          totalSeconds = paceSeconds * distanceKm;
        } else if (inputType === "speed" && speedValue > 0) {
          totalSeconds = (distanceKm / speedValue) * 3600;
        }
      }

      const finalPace = totalSeconds > 0 && distanceKm > 0 ? totalSeconds / distanceKm : 0;
      const finalSpeed = totalSeconds > 0 ? distanceKm / (totalSeconds / 3600) : 0;

      flexResultTime.textContent = formatTime(totalSeconds);
      flexResultPace.textContent = formatPaceByUnit(finalPace);
      flexResultSpeed.textContent = formatSpeedByUnit(finalSpeed);
      updateProgressMode();
    }

    function updateProgressMode() {
      const totalDistanceKm = convertDistanceToKm(toNumber(flexDistance.value));
      const currentDistanceKm = convertDistanceToKm(toNumber(progressCurrentDistance.value));
      const elapsedSeconds = parseTime(progressHour.value, progressMin.value, progressSec.value);
      const targetSeconds = parseTime(targetHour.value, targetMin.value, targetSec.value);

      const currentPace = currentDistanceKm > 0 ? elapsedSeconds / currentDistanceKm : 0;
      const predictedFinish = totalDistanceKm > 0 && currentPace > 0 ? totalDistanceKm * currentPace : 0;

      progressResultTime.textContent = formatTime(predictedFinish);
      progressResultPace.textContent = formatPaceByUnit(currentPace);

      if (targetSeconds > 0 && totalDistanceKm > 0 && currentPace > 0) {
        const targetPace = targetSeconds / totalDistanceKm;
        const diff = currentPace - targetPace;
        const diffText = diff === 0 ? "持平" : diff > 0 ? "慢于目标" : "快于目标";
        progressResultDiff.textContent = `${diffText} ${formatPaceByUnit(Math.abs(diff))}`;
        progressDiffHint.textContent = `目标配速：${formatPaceByUnit(targetPace)}`;
      } else {
        progressResultDiff.textContent = "--";
        progressDiffHint.textContent = "填写目标完赛时间后计算";
      }

      const remainingDistanceKm = totalDistanceKm - currentDistanceKm;
      const remainingSeconds = targetSeconds - elapsedSeconds;
      if (remainingDistanceKm > 0 && remainingSeconds > 0) {
        const segmentData = buildSegments(remainingDistanceKm, remainingSeconds);
        if (segmentData && segmentData.segments.length > 0) {
          remainingSegmentCard.hidden = false;
          remainingTitle.textContent = `剩余 ${formatDistance(remainingDistanceKm, 2)} 配速表`;
          remainingUnit.textContent = unitLabels[currentUnit].name;
          remainingRule.textContent = `按剩余距离每 ${segmentData.segmentSize} ${unitLabels[currentUnit].distanceUnit} 分段`;
          renderSegmentTable(segmentData.segments, remainingTableBody);
        } else {
          remainingSegmentCard.hidden = true;
        }
      } else {
        remainingSegmentCard.hidden = true;
      }
    }

    function bindInputs(inputs, handler) {
      inputs.forEach((input) => {
        input.addEventListener("input", handler);
        input.addEventListener("change", handler);
      });
    }

    bindInputs([quickInputType, timeHour, timeMin, timeSec, paceMin, paceSec, speedInput], updateQuickMode);
    bindInputs(
      [flexDistance, flexInputType, flexHour, flexMin, flexSec, flexPaceMin, flexPaceSec, flexSpeed],
      updateFlexMode
    );
    bindInputs(
      [progressCurrentDistance, progressHour, progressMin, progressSec, targetHour, targetMin, targetSec],
      updateProgressMode
    );

    unitButtons.forEach((button) => {
      button.addEventListener("click", () => {
        unitButtons.forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");
        const nextUnit = button.dataset.unit;
        convertUnits(currentUnit, nextUnit);
        currentUnit = nextUnit;
        updateUnitLabels();
        updateQuickMode();
        updateFlexMode();
        updateProgressMode();
      });
    });

    document.querySelectorAll(".mode-toggle button").forEach((button) => {
      button.addEventListener("click", () => {
        document.querySelectorAll(".mode-toggle button").forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");
        const mode = button.dataset.mode;
        document.getElementById("quick-section").classList.toggle("active", mode === "quick");
        document.getElementById("flex-section").classList.toggle("active", mode === "flex");
      });
    });

    updateQuickMode();
    updateFlexMode();
    updateProgressMode();
    updateUnitLabels();

    copyButton.addEventListener("click", async () => {
      const url = window.location.href;
      try {
        await navigator.clipboard.writeText(url);
        copyButton.textContent = "已复制";
      } catch (error) {
        window.prompt("复制失败，请手动复制：", url);
      }
      window.setTimeout(() => {
        copyButton.textContent = "复制此工具链接";
      }, 1500);
    });
  </script>
</body>
</html>
